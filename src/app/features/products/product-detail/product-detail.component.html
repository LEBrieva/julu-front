<div class="product-detail-container">
  <!-- LOADING STATE -->
  @if (loading()) {
    <div class="state-container loading-state">
      <p-progressSpinner
        styleClass="w-16 h-16"
        strokeWidth="4"
      />
      <p class="text-gray-600 mt-4 text-lg">Carregando produto...</p>
    </div>
  }

  <!-- ERROR STATE -->
  @else if (error()) {
    <div class="state-container error-state">
      <i class="pi pi-exclamation-triangle text-6xl text-red-500"></i>
      <p class="text-red-600 mt-4 text-xl">{{ error() }}</p>
      <div class="flex gap-3 mt-6">
        <p-button
          label="Voltar ao Catálogo"
          icon="pi pi-arrow-left"
          (onClick)="goBack()"
          severity="secondary"
          [outlined]="true"
        />
        <p-button
          label="Tentar Novamente"
          icon="pi pi-refresh"
          (onClick)="retry()"
          severity="danger"
        />
      </div>
    </div>
  }

  <!-- PRODUCT DETAIL -->
  @else if (product()) {
    <div class="product-detail-content">
      <!-- Breadcrumbs -->
      <div class="breadcrumbs-section">
        <p-breadcrumb
          [model]="breadcrumbItems()"
          [home]="{icon: 'pi pi-home', routerLink: '/'}"
        />
      </div>

      <!-- Main Product Grid (3 columns: thumbnails | main-image | info) -->
      <div class="product-detail-grid">
        <!-- Column 1: Thumbnails Verticales -->
        <div class="thumbnails-column">
          @for (image of galleryImages(); track $index) {
            <div
              class="thumbnail-item"
              [class.active]="currentImageIndex() === $index"
              (click)="selectImage($index)"
            >
              <img [src]="image" [alt]="product()!.name" />
            </div>
          }
        </div>

        <!-- Column 2: Main Image -->
        <div class="main-image-column">
          <p-image
            [src]="currentImage()"
            [alt]="product()!.name"
            [preview]="true"
            imageClass="product-main-image-large"
          />
        </div>

        <!-- Column 3: Product Info Panel -->
        <div class="product-info-panel">
          <!-- 1. Product Title -->
          <h1 class="product-title">{{ product()!.name }}</h1>

          <!-- 2. Price -->
          <div class="product-price-large">
            {{ product()!.basePrice | currency:'ARS':'symbol-narrow':'1.0-0' }}
          </div>

          <!-- 3. Rating + Reviews -->
          <div class="rating-section">
            <p-rating
              [ngModel]="rating()"
              [readonly]="true"
              [stars]="5"
            />
            <span class="reviews-text">{{ reviewsCount() }} reviews</span>
          </div>

          <!-- 4. Seletor de Cor -->
          <div class="option-group">
            <label class="option-label">Cor</label>
            <div class="color-chips">
              @for (color of availableColors(); track color) {
                <button
                  class="color-chip"
                  [class.selected]="selectedColor() === color"
                  [style.background-color]="getColorHex(color)"
                  (click)="selectedColor.set(color)"
                  [title]="formatColor(color)"
                >
                  @if (selectedColor() === color) {
                    <i class="pi pi-check"></i>
                  }
                </button>
              }
            </div>
            @if (selectedColor()) {
              <span class="selected-option-text">{{ formatColor(selectedColor()!) }}</span>
            }
          </div>

          <!-- 5. Seletor de Tamanho -->
          <div class="option-group">
            <div class="option-header">
              <label class="option-label">Tamanho</label>
              <button class="size-guide-link">
                Guia de Tamanho <i class="pi pi-angle-right"></i>
              </button>
            </div>
            <div class="size-buttons">
              @for (size of allSizes; track size) {
                <button
                  class="size-btn"
                  [class.selected]="selectedSize() === size"
                  [disabled]="!availableSizes().includes(size)"
                  (click)="selectedSize.set(size)"
                >
                  {{ size }}
                </button>
              }
            </div>
          </div>

          <!-- 6. Quantidade -->
          <div class="option-group">
            <label class="option-label">Quantidade</label>
            <p-inputNumber
              [(ngModel)]="quantity"
              [showButtons]="true"
              buttonLayout="horizontal"
              incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"
              [min]="1"
              [max]="maxQuantity()"
              [disabled]="!selectedVariant()"
            />
            @if (selectedVariant()) {
              <span class="stock-info-text">{{ selectedVariant()!.stock }} em estoque</span>
            }
          </div>

          <!-- 7. Action Buttons (Add to Cart + Favorite) -->
          <div class="action-buttons">
            <p-button
              label="Agregar al Carrito"
              icon="pi pi-shopping-cart"
              [disabled]="!selectedVariant() || selectedVariant()!.stock === 0"
              [loading]="addingToCart()"
              (onClick)="addToCart()"
              size="large"
              styleClass="add-to-cart-btn"
            />
            <p-button
              icon="pi pi-heart"
              [outlined]="true"
              severity="secondary"
              size="large"
              pTooltip="Adicionar aos favoritos"
            />
          </div>
        </div>
      </div>

      <!-- Seção de Abas (Descrição do Produto, Avaliações, Entrega, Devoluções) -->
      <div class="product-tabs-section">
        <p-tabs value="0">
          <p-tablist>
            <p-tab value="0">Descrição</p-tab>
            <p-tab value="1">Avaliações</p-tab>
            <p-tab value="2">Entrega</p-tab>
            <p-tab value="3">Devolução</p-tab>
          </p-tablist>

          <p-tabpanels>
            <!-- Aba 1: Descrição do Produto -->
            <p-tabpanel value="0">
              <div class="tab-content">
                <p class="tab-content-text">
                  {{ product()?.description || 'Nenhuma descrição disponível para este produto.' }}
                </p>

                <h4 class="tab-content-subtitle">Especificações</h4>
                <div class="specs-grid">
                  <div class="spec-item">
                    <strong>Categoria:</strong> {{ formatEnumValue(product()!.category) }}
                  </div>
                  <div class="spec-item">
                    <strong>Estilo:</strong> {{ formatStyle(product()!.style) }}
                  </div>
                  <div class="spec-item">
                    <strong>Código:</strong> {{ product()!.code }}
                  </div>
                </div>

                @if (product()?.tags && product()!.tags!.length > 0) {
                  <h4 class="tab-content-subtitle">Tags</h4>
                  <div class="tags-list">
                    @for (tag of product()!.tags; track tag) {
                      <p-tag [value]="tag" severity="secondary" />
                    }
                  </div>
                }
              </div>
            </p-tabpanel>

            <!-- Aba 2: Avaliações de Clientes -->
            <p-tabpanel value="1">
              <div class="tab-content">
                <div class="reviews-placeholder">
                  <p class="text-gray-500 italic mb-4">
                    O sistema de avaliações estará disponível em fases futuras.
                  </p>
                  <div class="review-summary">
                    <p><strong>Classificação Média:</strong> {{ rating() }}/5.0 ★★★★☆</p>
                    <p><strong>Total de Avaliações:</strong> {{ reviewsCount() }}</p>
                  </div>
                </div>
              </div>
            </p-tabpanel>

            <!-- Aba 3: Informações de Entrega -->
            <p-tabpanel value="2">
              <div class="tab-content">
                <p class="tab-content-text">
                  Frete grátis em compras acima de R$ 200.
                </p>
                <p class="tab-content-text">
                  Entrega estimada: 3-5 dias úteis.
                </p>
              </div>
            </p-tabpanel>

            <!-- Aba 4: Política de Devoluções -->
            <p-tabpanel value="3">
              <div class="tab-content">
                <p class="tab-content-text">
                  Política de devolução de 30 dias. Os produtos devem estar em condições originais com etiquetas anexadas.
                </p>
                <p class="tab-content-text">
                  Os reembolsos serão processados em 5-7 dias úteis após recebermos sua devolução.
                </p>
              </div>
            </p-tabpanel>
          </p-tabpanels>
        </p-tabs>
      </div>

      <!-- SEÇÃO DE PRODUTOS RELACIONADOS (FASE 8c) -->
      <div class="related-products-section">
        <h2 class="related-products-title">Produtos Relacionados</h2>

        @if (relatedLoading()) {
          <div class="related-loading">
            <p-progressSpinner
              styleClass="w-12 h-12"
              strokeWidth="4"
            />
            <p class="text-gray-600 mt-3">Carregando produtos relacionados...</p>
          </div>
        } @else if (relatedError()) {
          <div class="related-error">
            <i class="pi pi-exclamation-circle text-yellow-600 text-2xl"></i>
            <p class="text-gray-600 mt-2">{{ relatedError() }}</p>
          </div>
        } @else if (relatedProducts().length > 0) {
          <p-carousel
            [value]="relatedProducts()"
            [numVisible]="3"
            [numScroll]="1"
            [responsiveOptions]="relatedProductsCarouselConfig"
            [circular]="false"
            [showIndicators]="false"
            [showNavigators]="true"
            styleClass="related-carousel"
          >
            <ng-template pTemplate="item" let-product>
              <div class="carousel-item-wrapper">
                <app-product-card
                  [product]="product"
                  viewMode="grid"
                />
              </div>
            </ng-template>
          </p-carousel>
        } @else {
          <div class="related-empty">
            <i class="pi pi-inbox text-gray-400 text-4xl"></i>
            <p class="text-gray-500 mt-3">Nenhum produto relacionado disponível</p>
          </div>
        }
      </div>
    </div>
  }
</div>
