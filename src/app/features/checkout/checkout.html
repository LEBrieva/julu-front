<div class="container mx-auto px-4 py-8 max-w-6xl">
  <h1 class="text-3xl font-bold mb-6">Finalizar Compra</h1>

  <!-- Steps indicator -->
  <div class="mb-8">
    <p-steps
      [model]="steps"
      [activeIndex]="currentStep()"
      [readonly]="true"
      styleClass="mb-8"
    />
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main content area -->
    <div class="lg:col-span-2">
      <p-card>
        <!-- STEP 0: Revisión de productos -->
        @if (currentStep() === 0) {
          <div class="space-y-4">
            <h2 class="text-xl font-bold mb-4">Revise seu pedido</h2>

            @for (item of cartItems(); track $index) {
              <div
                class="flex gap-4 p-4 border border-gray-200 rounded-lg items-center"
              >
                <img
                  [src]="item.productImage || '/assets/images/placeholder.jpg'"
                  [alt]="item.productName"
                  class="w-20 h-20 object-cover rounded-lg"
                />
                <div class="flex-1">
                  <h3 class="font-semibold">{{ item.productName }}</h3>
                  <p class="text-sm text-gray-600">
                    {{ formatSize(item.variantSize) }} •
                    {{ formatColor(item.variantColor) }}
                  </p>
                  <p class="text-sm text-gray-600">Quantidade: {{ item.quantity }}</p>
                </div>
                <div class="text-right">
                  <p class="font-bold text-lg">
                    R$ {{ (item.priceAtAdd * item.quantity) | number: '1.2-2' }}
                  </p>
                </div>
              </div>
            }

            <div class="flex justify-end mt-6">
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStep()"
              />
            </div>
          </div>
        }

        <!-- STEP 1: Dirección de envío -->
        @if (currentStep() === 1) {
          <div>
            <h2 class="text-xl font-bold mb-4">Endereço de Entrega</h2>

            @if (!creatingNewAddress()) {
              <!-- Lista de direcciones existentes -->
              <div class="space-y-3 mb-4">
                @for (address of addresses(); track address.id) {
                  <div
                    class="p-4 border rounded-lg cursor-pointer transition"
                    [class.border-blue-500]="selectedAddressId() === address.id"
                    [class.bg-blue-50]="selectedAddressId() === address.id"
                    [class.border-gray-200]="selectedAddressId() !== address.id"
                    (click)="selectAddress(address.id)"
                  >
                    <div class="flex items-start gap-3">
                      <p-radioButton
                        [value]="address.id"
                        [(ngModel)]="selectedAddressId"
                        [ngModelOptions]="{ standalone: true }"
                      />
                      <div class="flex-1">
                        <p class="font-semibold">{{ address.fullName }}</p>
                        <p class="text-sm text-gray-600">
                          {{ address.street }}
                        </p>
                        <p class="text-sm text-gray-600">
                          {{ address.city }}, {{ address.state }} ({{ address.zipCode }})
                        </p>
                        <p class="text-sm text-gray-600">{{ address.phone }}</p>
                        @if (address.isDefault) {
                          <span
                            class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded mt-1 inline-block"
                          >
                            Padrão
                          </span>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>

              <p-button
                label="Adicionar Novo Endereço"
                icon="pi pi-plus"
                severity="secondary"
                [outlined]="true"
                (onClick)="toggleNewAddress()"
                styleClass="w-full mb-4"
              />
            } @else {
              <!-- Formulario de nueva dirección -->
              <form [formGroup]="addressForm" class="space-y-4">
                <div>
                  <label for="fullName" class="block text-sm font-medium mb-2">
                    Nome Completo *
                  </label>
                  <input
                    pInputText
                    id="fullName"
                    formControlName="fullName"
                    class="w-full"
                    placeholder="João Silva"
                  />
                  @if (getFieldError('fullName')) {
                    <small class="text-red-500">{{ getFieldError('fullName') }}</small>
                  }
                </div>

                <div>
                  <label for="street" class="block text-sm font-medium mb-2">
                    Rua e Número *
                  </label>
                  <input
                    pInputText
                    id="street"
                    formControlName="street"
                    class="w-full"
                    placeholder="Av. Paulista 1000"
                  />
                  @if (getFieldError('street')) {
                    <small class="text-red-500">{{ getFieldError('street') }}</small>
                  }
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="city" class="block text-sm font-medium mb-2">
                      Cidade *
                    </label>
                    <input
                      pInputText
                      id="city"
                      formControlName="city"
                      class="w-full"
                      placeholder="São Paulo"
                    />
                    @if (getFieldError('city')) {
                      <small class="text-red-500">{{ getFieldError('city') }}</small>
                    }
                  </div>

                  <div>
                    <label for="state" class="block text-sm font-medium mb-2">
                      Estado *
                    </label>
                    <input
                      pInputText
                      id="state"
                      formControlName="state"
                      class="w-full"
                      placeholder="SP"
                    />
                    @if (getFieldError('state')) {
                      <small class="text-red-500">{{ getFieldError('state') }}</small>
                    }
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label for="zipCode" class="block text-sm font-medium mb-2">
                      CEP *
                    </label>
                    <p-inputMask
                      id="zipCode"
                      formControlName="zipCode"
                      mask="9999"
                      placeholder="1234"
                      styleClass="w-full"
                    />
                    @if (getFieldError('zipCode')) {
                      <small class="text-red-500">{{ getFieldError('zipCode') }}</small>
                    }
                  </div>

                  <div>
                    <label for="phone" class="block text-sm font-medium mb-2">
                      Telefone *
                    </label>
                    <p-inputMask
                      id="phone"
                      formControlName="phone"
                      mask="9999999999"
                      placeholder="11987654321"
                      styleClass="w-full"
                    />
                    @if (getFieldError('phone')) {
                      <small class="text-red-500">{{ getFieldError('phone') }}</small>
                    }
                  </div>
                </div>

                <div>
                  <label for="country" class="block text-sm font-medium mb-2">
                    País *
                  </label>
                  <input
                    pInputText
                    id="country"
                    formControlName="country"
                    class="w-full"
                    [readonly]="true"
                  />
                </div>
              </form>

              <p-button
                label="Voltar para Endereços"
                icon="pi pi-arrow-left"
                severity="secondary"
                [text]="true"
                (onClick)="toggleNewAddress()"
                styleClass="mt-4"
              />
            }

            <div class="flex justify-between mt-6">
              <p-button
                label="Voltar"
                icon="pi pi-arrow-left"
                severity="secondary"
                [outlined]="true"
                (onClick)="prevStep()"
              />
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStep()"
              />
            </div>
          </div>
        }

        <!-- STEP 2: Método de pago -->
        @if (currentStep() === 2) {
          <div>
            <h2 class="text-xl font-bold mb-4">Método de Pagamento</h2>

            <!-- Opciones de pago -->
            <div class="space-y-3 mb-6">
              @for (method of paymentMethods; track method.value) {
                <div
                  class="p-4 border-2 rounded-lg cursor-pointer transition hover:bg-gray-50"
                  [class.border-blue-500]="selectedPaymentMethod().value === method.value"
                  [class.bg-blue-50]="selectedPaymentMethod().value === method.value"
                  [class.border-gray-200]="selectedPaymentMethod().value !== method.value"
                  (click)="selectPaymentMethod(method)"
                >
                  <div class="flex items-center gap-4">
                    <!-- Radio button -->
                    <p-radioButton
                      [value]="method"
                      [(ngModel)]="selectedPaymentMethod"
                      [ngModelOptions]="{ standalone: true }"
                    />

                    <!-- Icono -->
                    <div
                      class="flex items-center justify-center w-12 h-12 rounded-full"
                      [ngClass]="{
                        'bg-blue-100': selectedPaymentMethod().value === method.value,
                        'bg-gray-100': selectedPaymentMethod().value !== method.value
                      }"
                    >
                      <i
                        [class]="'pi ' + method.icon + ' text-2xl'"
                        [ngClass]="{
                          'text-blue-600': selectedPaymentMethod().value === method.value,
                          'text-gray-600': selectedPaymentMethod().value !== method.value
                        }"
                      ></i>
                    </div>

                    <!-- Info -->
                    <div class="flex-1">
                      <h3 class="font-semibold text-lg">{{ method.label }}</h3>
                      <p class="text-sm text-gray-600">{{ method.description }}</p>
                    </div>

                    <!-- Badge de recargo -->
                    @if (method.surchargeRate > 0) {
                      <span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-sm font-semibold rounded-full">
                        +{{ (method.surchargeRate * 100) }}%
                      </span>
                    } @else {
                      <span class="px-3 py-1 bg-green-100 text-green-800 text-sm font-semibold rounded-full">
                        Grátis
                      </span>
                    }
                  </div>
                </div>
              }
            </div>

            <!-- Información adicional según método -->
            @if (selectedPaymentMethod().value === 'pix') {
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
                <p class="text-sm text-blue-800">
                  <i class="pi pi-info-circle mr-2"></i>
                  Você será redirecionado para o Mercado Pago para escanear o QR code.
                  A aprovação é instantânea.
                </p>
              </div>
            }

            @if (selectedPaymentMethod().value === 'credit_card') {
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
                <p class="text-sm text-blue-800">
                  <i class="pi pi-info-circle mr-2"></i>
                  Parcelamento em até 6x sem juros. Você será redirecionado para o Mercado Pago.
                </p>
              </div>
            }

            <div class="flex justify-between mt-6">
              <p-button
                label="Voltar"
                icon="pi pi-arrow-left"
                severity="secondary"
                [outlined]="true"
                (onClick)="prevStep()"
              />
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStep()"
              />
            </div>
          </div>
        }

        <!-- STEP 3: Confirmación -->
        @if (currentStep() === 3) {
          <div>
            <h2 class="text-xl font-bold mb-4">Confirmação</h2>

            <div class="space-y-4">
              <!-- Resumen de dirección -->
              <div class="p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">Endereço de Entrega</h3>
                @if (!creatingNewAddress() && selectedAddressId()) {
                  @for (address of addresses(); track address.id) {
                    @if (address.id === selectedAddressId()) {
                      <p class="text-sm text-gray-700">{{ address.fullName }}</p>
                      <p class="text-sm text-gray-700">{{ address.street }}</p>
                      <p class="text-sm text-gray-700">
                        {{ address.city }}, {{ address.state }} ({{ address.zipCode }})
                      </p>
                      <p class="text-sm text-gray-700">{{ address.phone }}</p>
                    }
                  }
                } @else {
                  <p class="text-sm text-gray-700">
                    {{ addressForm.get('fullName')?.value }}
                  </p>
                  <p class="text-sm text-gray-700">
                    {{ addressForm.get('street')?.value }}
                  </p>
                  <p class="text-sm text-gray-700">
                    {{ addressForm.get('city')?.value }},
                    {{ addressForm.get('state')?.value }}
                    ({{ addressForm.get('zipCode')?.value }})
                  </p>
                  <p class="text-sm text-gray-700">
                    {{ addressForm.get('phone')?.value }}
                  </p>
                }
              </div>

              <!-- Resumen de método de pago -->
              <div class="p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">Método de Pagamento</h3>
                <p class="text-sm text-gray-700">{{ selectedPaymentMethod().label }}</p>
              </div>

              <!-- Términos y condiciones -->
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-gray-700">
                  <i class="pi pi-info-circle text-blue-600 mr-2"></i>
                  Ao confirmar seu pedido, você aceita nossos termos e condições
                  de venda.
                </p>
              </div>
            </div>

            <div class="flex justify-between mt-6">
              <p-button
                label="Voltar"
                icon="pi pi-arrow-left"
                severity="secondary"
                [outlined]="true"
                (onClick)="prevStep()"
                [disabled]="creatingPreference()"
              />
              <p-button
                label="Confirmar Pedido"
                icon="pi pi-check"
                iconPos="right"
                [loading]="creatingPreference()"
                (onClick)="completeOrder()"
              />
            </div>
          </div>
        }
      </p-card>
    </div>

    <!-- Sidebar con resumen -->
    <div class="lg:col-span-1">
      <p-card>
        <h2 class="text-lg font-bold mb-4">Resumo do Pedido</h2>

        <div class="space-y-3 mb-6">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Subtotal</span>
            <span class="font-semibold">R$ {{ subtotal() | number: '1.2-2' }}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Envio</span>
            <span class="font-semibold">R$ {{ SHIPPING_COST | number: '1.2-2' }}</span>
          </div>

          <!-- Mostrar recargo si aplica -->
          @if (montoRecargo() > 0) {
            <div class="flex justify-between text-sm text-yellow-700">
              <span>Acréscimo ({{ (selectedPaymentMethod().surchargeRate * 100) }}%)</span>
              <span class="font-semibold">R$ {{ montoRecargo() | number: '1.2-2' }}</span>
            </div>
          }

          <p-divider />
          <div class="flex justify-between">
            <span class="font-bold">Total</span>
            <span class="font-bold text-xl text-blue-600">
              R$ {{ total() | number: '1.2-2' }}
            </span>
          </div>
        </div>

        <div class="space-y-2 text-sm text-gray-600">
          <p>
            <i class="pi pi-shield text-green-600 mr-2"></i>
            Compra segura e protegida
          </p>
          <p>
            <i class="pi pi-truck text-blue-600 mr-2"></i>
            Entrega em todo o país
          </p>
          <p>
            <i class="pi pi-replay text-purple-600 mr-2"></i>
            Devolução gratuita
          </p>
        </div>
      </p-card>
    </div>
  </div>
</div>
