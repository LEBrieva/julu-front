<div class="container mx-auto px-4 py-8 max-w-6xl">
  <!-- Header com título e botão fechar -->
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold">Finalizar Compra como Convidado</h1>
    <button
      type="button"
      (click)="goBackToCart()"
      class="p-2 hover:bg-gray-100 rounded-full transition-colors"
      title="Voltar ao carrinho"
      aria-label="Fechar e voltar ao carrinho"
    >
      <i class="pi pi-times text-2xl text-gray-600"></i>
    </button>
  </div>

  <!-- Steps indicator -->
  <div class="mb-8">
    <p-steps
      [model]="steps"
      [activeIndex]="currentStep()"
      [readonly]="true"
      styleClass="mb-8"
    />
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main content area -->
    <div class="lg:col-span-2">
      <p-card>
        <!-- STEP 0: Email -->
        @if (currentStep() === 0) {
          <div>
            <h2 class="text-xl font-bold mb-4">Informe seu Email</h2>
            <p class="text-gray-600 mb-6">
              Enviaremos a confirmação do seu pedido para este email
            </p>

            <form [formGroup]="emailForm" class="space-y-4">
              <div>
                <label for="email" class="block text-sm font-medium mb-2">
                  Email *
                </label>
                <input
                  pInputText
                  id="email"
                  formControlName="email"
                  type="email"
                  class="w-full"
                  placeholder="seu@email.com"
                />
                @if (getEmailError()) {
                  <small class="text-red-500">{{ getEmailError() }}</small>
                }
              </div>
            </form>

            <div class="flex justify-end mt-6">
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStep()"
              />
            </div>
          </div>
        }

        <!-- STEP 1: Endereço de entrega -->
        @if (currentStep() === 1) {
          <div>
            <h2 class="text-xl font-bold mb-4">Endereço de Entrega</h2>

            <form [formGroup]="addressForm" class="space-y-4">
              <div>
                <label for="fullName" class="block text-sm font-medium mb-2">
                  Nome Completo *
                </label>
                <input
                  pInputText
                  id="fullName"
                  formControlName="fullName"
                  class="w-full"
                  placeholder="João Silva"
                />
                @if (getFieldError('fullName')) {
                  <small class="text-red-500">{{ getFieldError('fullName') }}</small>
                }
              </div>

              <div>
                <label for="street" class="block text-sm font-medium mb-2">
                  Rua e Número *
                </label>
                <input
                  pInputText
                  id="street"
                  formControlName="street"
                  class="w-full"
                  placeholder="Av. Paulista 1000"
                />
                @if (getFieldError('street')) {
                  <small class="text-red-500">{{ getFieldError('street') }}</small>
                }
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="city" class="block text-sm font-medium mb-2">
                    Cidade *
                  </label>
                  <input
                    pInputText
                    id="city"
                    formControlName="city"
                    class="w-full"
                    placeholder="São Paulo"
                  />
                  @if (getFieldError('city')) {
                    <small class="text-red-500">{{ getFieldError('city') }}</small>
                  }
                </div>

                <div>
                  <label for="state" class="block text-sm font-medium mb-2">
                    Estado *
                  </label>
                  <input
                    pInputText
                    id="state"
                    formControlName="state"
                    class="w-full"
                    placeholder="SP"
                  />
                  @if (getFieldError('state')) {
                    <small class="text-red-500">{{ getFieldError('state') }}</small>
                  }
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="zipCode" class="block text-sm font-medium mb-2">
                    CEP *
                  </label>
                  <p-inputMask
                    id="zipCode"
                    formControlName="zipCode"
                    mask="9999"
                    placeholder="1234"
                    styleClass="w-full"
                  />
                  @if (getFieldError('zipCode')) {
                    <small class="text-red-500">{{ getFieldError('zipCode') }}</small>
                  }
                </div>

                <div>
                  <label for="phone" class="block text-sm font-medium mb-2">
                    Telefone *
                  </label>
                  <p-inputMask
                    id="phone"
                    formControlName="phone"
                    mask="9999999999"
                    placeholder="11987654321"
                    styleClass="w-full"
                  />
                  @if (getFieldError('phone')) {
                    <small class="text-red-500">{{ getFieldError('phone') }}</small>
                  }
                </div>
              </div>

              <div>
                <label for="country" class="block text-sm font-medium mb-2">
                  País *
                </label>
                <input
                  pInputText
                  id="country"
                  formControlName="country"
                  class="w-full"
                  [readonly]="true"
                />
              </div>
            </form>

            <div class="flex justify-between mt-6">
              <p-button
                label="Voltar"
                icon="pi pi-arrow-left"
                severity="secondary"
                [outlined]="true"
                (onClick)="prevStep()"
              />
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStep()"
              />
            </div>
          </div>
        }

        <!-- STEP 2: Método de pagamento -->
        @if (currentStep() === 2) {
          <div>
            <h2 class="text-xl font-bold mb-4">Método de Pagamento</h2>

            <!-- Opciones de pago -->
            <div class="space-y-3 mb-6">
              @for (method of paymentMethods; track method.value) {
                <div
                  class="p-4 border-2 rounded-lg cursor-pointer transition hover:bg-gray-50"
                  [class.border-blue-500]="selectedPaymentMethod().value === method.value"
                  [class.bg-blue-50]="selectedPaymentMethod().value === method.value"
                  [class.border-gray-200]="selectedPaymentMethod().value !== method.value"
                  (click)="selectPaymentMethod(method)"
                >
                  <div class="flex items-center gap-4">
                    <!-- Radio button -->
                    <p-radioButton
                      [value]="method"
                      [(ngModel)]="selectedPaymentMethod"
                      [ngModelOptions]="{ standalone: true }"
                    />

                    <!-- Icono -->
                    <div
                      class="flex items-center justify-center w-12 h-12 rounded-full"
                      [ngClass]="{
                        'bg-blue-100': selectedPaymentMethod().value === method.value,
                        'bg-gray-100': selectedPaymentMethod().value !== method.value
                      }"
                    >
                      <i
                        [class]="'pi ' + method.icon + ' text-2xl'"
                        [ngClass]="{
                          'text-blue-600': selectedPaymentMethod().value === method.value,
                          'text-gray-600': selectedPaymentMethod().value !== method.value
                        }"
                      ></i>
                    </div>

                    <!-- Info -->
                    <div class="flex-1">
                      <h3 class="font-semibold text-lg">{{ method.label }}</h3>
                      <p class="text-sm text-gray-600">{{ method.description }}</p>
                    </div>

                    <!-- Badge de recargo -->
                    @if (method.surchargeRate > 0) {
                      <span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-sm font-semibold rounded-full">
                        +{{ (method.surchargeRate * 100) }}%
                      </span>
                    } @else {
                      <span class="px-3 py-1 bg-green-100 text-green-800 text-sm font-semibold rounded-full">
                        Grátis
                      </span>
                    }
                  </div>
                </div>
              }
            </div>

            <!-- Información adicional según método -->
            @if (selectedPaymentMethod().value === 'pix') {
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
                <p class="text-sm text-blue-800">
                  <i class="pi pi-info-circle mr-2"></i>
                  Você será redirecionado para o Mercado Pago para escanear o QR code.
                  A aprovação é instantânea.
                </p>
              </div>
            }

            @if (selectedPaymentMethod().value === 'credit_card') {
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
                <p class="text-sm text-blue-800">
                  <i class="pi pi-info-circle mr-2"></i>
                  Parcelamento em até 6x sem juros. Você será redirecionado para o Mercado Pago.
                </p>
              </div>
            }

            <div class="flex justify-between mt-6">
              <p-button
                label="Voltar"
                icon="pi pi-arrow-left"
                severity="secondary"
                [outlined]="true"
                (onClick)="prevStep()"
              />
              <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                iconPos="right"
                (onClick)="nextStep()"
              />
            </div>
          </div>
        }

        <!-- STEP 3: Confirmação -->
        @if (currentStep() === 3) {
          <div>
            <h2 class="text-xl font-bold mb-6">Revise e Confirme seu Pedido</h2>

            <div class="space-y-4">
              <!-- Resumen de email -->
              <div class="p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">Email de Confirmação</h3>
                <p class="text-sm text-gray-700">
                  {{ emailForm.get('email')?.value }}
                </p>
              </div>

              <!-- Resumen de endereço -->
              <div class="p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">Endereço de Entrega</h3>
                <p class="text-sm text-gray-700">
                  {{ addressForm.get('fullName')?.value }}
                </p>
                <p class="text-sm text-gray-700">
                  {{ addressForm.get('street')?.value }}
                </p>
                <p class="text-sm text-gray-700">
                  {{ addressForm.get('city')?.value }},
                  {{ addressForm.get('state')?.value }}
                  ({{ addressForm.get('zipCode')?.value }})
                </p>
                <p class="text-sm text-gray-700">
                  Tel: {{ addressForm.get('phone')?.value }}
                </p>
              </div>

              <!-- Resumen de método de pago -->
              <div class="p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold mb-2">Método de Pagamento</h3>
                <p class="text-sm text-gray-700">{{ selectedPaymentMethod().label }}</p>
              </div>

              <!-- Términos y condiciones -->
              <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-gray-700">
                  <i class="pi pi-info-circle text-blue-600 mr-2"></i>
                  Ao confirmar seu pedido, você aceita nossos termos e condições
                  de venda.
                </p>
              </div>
            </div>

            <div class="flex justify-between mt-6">
              <p-button
                label="Voltar"
                icon="pi pi-arrow-left"
                severity="secondary"
                [outlined]="true"
                (onClick)="prevStep()"
                [disabled]="creatingPreference()"
              />
              <p-button
                label="Confirmar Pedido"
                icon="pi pi-check"
                iconPos="right"
                [loading]="creatingPreference()"
                (onClick)="completeOrder()"
              />
            </div>
          </div>
        }
      </p-card>
    </div>

    <!-- Sidebar com resumo -->
    <div class="lg:col-span-1">
      <p-card>
        <h2 class="text-lg font-bold mb-4">Resumo do Pedido</h2>

        <div class="space-y-3 mb-6">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Subtotal</span>
            <span class="font-semibold">R$ {{ subtotal() | number: '1.2-2' }}</span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Envio</span>
            <span class="font-semibold">R$ {{ SHIPPING_COST | number: '1.2-2' }}</span>
          </div>

          <!-- Mostrar recargo si aplica -->
          @if (montoRecargo() > 0) {
            <div class="flex justify-between text-sm text-yellow-700">
              <span>Acréscimo ({{ (selectedPaymentMethod().surchargeRate * 100) }}%)</span>
              <span class="font-semibold">R$ {{ montoRecargo() | number: '1.2-2' }}</span>
            </div>
          }

          <p-divider />
          <div class="flex justify-between">
            <span class="font-bold">Total</span>
            <span class="font-bold text-xl text-blue-600">
              R$ {{ total() | number: '1.2-2' }}
            </span>
          </div>
        </div>

        <div class="space-y-2 text-sm text-gray-600">
          <p>
            <i class="pi pi-shield text-green-600 mr-2"></i>
            Compra segura e protegida
          </p>
          <p>
            <i class="pi pi-truck text-blue-600 mr-2"></i>
            Entrega em todo o país
          </p>
          <p>
            <i class="pi pi-replay text-purple-600 mr-2"></i>
            Devolução gratuita
          </p>
        </div>
      </p-card>
    </div>
  </div>
</div>
