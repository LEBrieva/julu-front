<p-dialog
  [visible]="visible()"
  (visibleChange)="visibleChange.emit($event)"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '600px' }"
  [breakpoints]="{ '768px': '95vw' }"
  styleClass="user-detail-dialog"
>
  <!-- Header personalizado -->
  <ng-template pTemplate="header">
    <div class="flex items-center gap-3">
      <i class="pi pi-user text-blue-500 text-2xl"></i>
      <div>
        <h3 class="text-xl font-bold text-gray-800 m-0">Detalhe do Usuário</h3>
      </div>
    </div>
  </ng-template>

  <!-- Conteúdo -->
  @if (user()) {
    <div class="user-detail-content">
      <!-- Avatar e nome -->
      <div class="user-header">
        @if (user()!.avatar || avatarPreview()) {
          <img
            [src]="avatarPreview() || user()!.avatar"
            [alt]="user()!.firstName || 'User'"
            [class]="readonly() ? 'user-avatar-large' : 'user-avatar-large avatar-clickable'"
            (click)="onAvatarClick()"
            [title]="readonly() ? user()!.firstName || 'Usuário' : 'Clique para ampliar'"
          />
        } @else {
          <div
            [class]="readonly() ? 'user-avatar-large-placeholder' : 'user-avatar-large-placeholder avatar-clickable'"
            (click)="onAvatarClick()"
            [title]="readonly() ? user()!.firstName || 'Usuário' : 'Clique para ampliar'"
          >
            {{ user()!.firstName?.charAt(0) || 'U' }}{{ user()!.lastName?.charAt(0) || 'U' }}
          </div>
        }
        <div class="user-header-info">
          <h4 class="text-2xl font-bold text-gray-800">
            {{ user()!.firstName || 'N/A' }} {{ user()!.lastName || '' }}
          </h4>
          <p class="text-gray-600">{{ user()!.email }}</p>
        </div>
      </div>

      <!-- Grid de informações -->
      <div class="info-grid">
        <!-- Função -->
        <div class="info-item">
          <label class="info-label">Função</label>
          <div>
            <p-tag
              [value]="user()!.role === UserRole.ADMIN ? 'Administrador' : 'Usuário'"
              [severity]="getRoleSeverity(user()!.role)"
            />
          </div>
        </div>

        <!-- Status (editável ou somente leitura) -->
        <div class="info-item">
          <label class="info-label">Status</label>
          <div>
            @if (readonly()) {
              <p-tag
                [value]="user()!.status === UserStatus.ACTIVE ? 'Ativo' : 'Inativo'"
                [severity]="getStatusSeverity(user()!.status)"
              />
            } @else {
              <p-select
                [(ngModel)]="editableStatus"
                [options]="statusOptions"
                optionLabel="label"
                optionValue="value"
                styleClass="w-full"
              >
                <ng-template pTemplate="selectedItem" let-option>
                  <p-tag
                    [value]="option.label"
                    [severity]="getStatusSeverity(option.value)"
                  />
                </ng-template>
                <ng-template pTemplate="item" let-option>
                  <p-tag
                    [value]="option.label"
                    [severity]="getStatusSeverity(option.value)"
                  />
                </ng-template>
              </p-select>
            }
          </div>
        </div>

        <!-- Telefone (editável ou somente leitura) -->
        <div class="info-item">
          <label class="info-label">Telefone</label>
          <div class="flex items-center gap-2">
            @if (readonly()) {
              <p class="info-value">{{ user()!.phone || 'Não especificado' }}</p>
            } @else {
              <input
                pInputText
                type="text"
                [(ngModel)]="editablePhone"
                placeholder="Não especificado"
                class="w-full"
              />
            }
          </div>
        </div>

        <!-- E-mail Verificado -->
        <div class="info-item">
          <label class="info-label">E-mail Verificado</label>
          <div class="flex items-center gap-2">
            @if (user()!.emailVerified) {
              <i class="pi pi-check-circle text-green-500 text-xl"></i>
              <span class="text-green-600 font-medium">Verificado</span>
            } @else {
              <i class="pi pi-times-circle text-gray-400 text-xl"></i>
              <span class="text-gray-500">Não verificado</span>
            }
          </div>
        </div>

        <!-- Último Acesso -->
        <div class="info-item">
          <label class="info-label">Último Acesso</label>
          <p class="info-value">{{ formatDate(user()!.lastLogin) }}</p>
        </div>

        <!-- Data de Cadastro -->
        <div class="info-item">
          <label class="info-label">Data de Cadastro</label>
          <p class="info-value">{{ formatDate(user()!.createdAt) }}</p>
        </div>
      </div>

      <!-- ID (para referência técnica) -->
      <div class="user-id">
        <label class="info-label">ID do Usuário</label>
        <code class="id-code">{{ user()!.id }}</code>
      </div>
    </div>
  }

  <!-- Footer -->
  <ng-template pTemplate="footer">
    @if (readonly()) {
      <!-- Modo somente leitura: apenas botão fechar centralizado -->
      <div class="flex justify-center w-full">
        <button
          pButton
          type="button"
          label="Fechar"
          icon="pi pi-times"
          (click)="closeDialog()"
          class="p-button-outlined"
        ></button>
      </div>
    } @else {
      <!-- Modo edição: botões fechar e salvar -->
      <div class="flex justify-between w-full">
        <button
          pButton
          type="button"
          label="Fechar"
          icon="pi pi-times"
          (click)="closeDialog()"
          class="p-button-outlined"
        ></button>
        <button
          pButton
          type="button"
          label="Salvar Alterações"
          icon="pi pi-check"
          (click)="saveChanges()"
          [disabled]="!hasChanges()"
          class="p-button-primary"
        ></button>
      </div>
    }
  </ng-template>
</p-dialog>

<!-- ConfirmDialog com template headless para mostrar alterações -->
<p-confirmDialog key="saveChanges">
  <ng-template #headless let-message let-onAccept="onAccept" let-onReject="onReject">
    <div class="flex flex-col items-center p-8 bg-surface-0 dark:bg-surface-900 rounded">
      <div class="rounded-full bg-primary text-primary-contrast inline-flex justify-center items-center h-24 w-24 -mt-20">
        <i [class]="message.icon || 'pi pi-save'" class="!text-5xl"></i>
      </div>
      <span class="font-bold text-2xl block mb-2 mt-6">{{ message.header }}</span>
      <p class="mb-0 text-center text-gray-700">{{ message.message }}</p>

      @if (pendingChanges.length > 0) {
        <div class="changes-list mt-4">
          <ul class="mb-0">
            @for (change of pendingChanges; track change) {
              <li>{{ change }}</li>
            }
          </ul>
        </div>
      }

      <div class="flex items-center gap-2 mt-6">
        <p-button
          [label]="message.acceptLabel || 'Confirmar'"
          (onClick)="onAccept()"
          styleClass="w-32"
        ></p-button>
        <p-button
          label="Cancelar"
          [outlined]="true"
          (onClick)="onReject()"
          styleClass="w-32"
        ></p-button>
      </div>
    </div>
  </ng-template>
</p-confirmDialog>

<!-- Avatar Overlay -->
<app-avatar-overlay
  [visible]="showAvatarOverlay()"
  (visibleChange)="showAvatarOverlay.set($event)"
  [avatarUrl]="user()?.avatar || null"
  [userInitials]="(user()?.firstName?.charAt(0) || 'U') + (user()?.lastName?.charAt(0) || 'U')"
  [userName]="(user()?.firstName || '') + ' ' + (user()?.lastName || '')"
  (avatarSelected)="onAvatarSelected($event)"
  (validationError)="onAvatarValidationError($event)"
/>
