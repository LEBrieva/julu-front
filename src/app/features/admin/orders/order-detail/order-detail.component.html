<!-- Toast para notificações -->
<p-toast />

<!-- Loading skeleton -->
@if (loading) {
  <div class="p-4">
    <div class="mb-6">
      <p-skeleton width="10rem" height="2rem" styleClass="mb-2" />
      <p-skeleton width="20rem" height="3rem" styleClass="mb-4" />
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
      <p-skeleton width="100%" height="15rem" />
      <p-skeleton width="100%" height="15rem" />
    </div>
    <p-skeleton width="100%" height="20rem" />
  </div>
}

<!-- Conteúdo principal (apenas se carregou) -->
@if (!loading && order) {
  <div class="p-4">
    <!-- Header -->
    <div class="mb-6">
      <!-- Botão voltar -->
      <p-button
        label="Voltar para Pedidos"
        icon="pi pi-arrow-left"
        severity="secondary"
        [text]="true"
        (onClick)="goBack()"
        styleClass="mb-4"
      />

      <!-- Título com número de pedido -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800 mb-2">
            {{ order.orderNumber }}
          </h1>
          <p class="text-gray-600">
            Criado: {{ formatDateLong(order.createdAt) }}
          </p>
        </div>

        <!-- Badges de estado -->
        <div class="flex flex-wrap gap-2">
          <p-tag
            [value]="formatOrderStatus(order.status)"
            [severity]="getOrderStatusSeverity(order.status)"
            styleClass="text-base px-4 py-2"
          />
          <p-tag
            [value]="formatPaymentStatus(order.paymentStatus)"
            [severity]="getPaymentStatusSeverity(order.paymentStatus)"
            styleClass="text-base px-4 py-2"
          />
        </div>
      </div>
    </div>

    <!-- Grid principal: Info + Produtos -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
      <!-- Coluna esquerda: Info Cliente + Endereço -->
      <div class="lg:col-span-2 space-y-4">
        <!-- Card: Informações do Cliente -->
        <p-card header="Informações do Cliente">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="text-sm font-medium text-gray-600 block mb-1">
                Nome Completo
              </label>
              <p class="text-gray-900 font-medium">
                {{ order.shippingAddress.fullName }}
              </p>
            </div>

            <div>
              <label class="text-sm font-medium text-gray-600 block mb-1">
                E-mail
              </label>
              <p class="text-gray-900">
                {{ order.shippingAddress.email }}
              </p>
            </div>

            <div>
              <label class="text-sm font-medium text-gray-600 block mb-1">
                Telefone
              </label>
              <p class="text-gray-900">
                {{ order.shippingAddress.phone }}
              </p>
            </div>

            <!-- Tipo de pedido + Botão ver perfil (apenas se não for guest) -->
            <div>
              <label class="text-sm font-medium text-gray-600 block mb-1">
                Tipo de Pedido
              </label>
              <div class="flex items-center gap-2">
                <p-tag
                  [value]="order.isGuest ? 'Visitante' : 'Registrado'"
                  [severity]="order.isGuest ? 'secondary' : 'info'"
                />
                @if (!order.isGuest && order.userId) {
                  <p-button
                    label="Ver perfil atual"
                    icon="pi pi-user"
                    size="small"
                    [text]="true"
                    (onClick)="viewUserProfile()"
                    [loading]="loadingUser()"
                  />
                }
              </div>
            </div>
          </div>
        </p-card>

        <!-- Card: Endereço de Entrega -->
        <p-card header="Endereço de Entrega">
          <div class="space-y-2">
            <p class="text-gray-900 font-medium">
              {{ order.shippingAddress.fullName }}
            </p>
            <p class="text-gray-700">
              {{ order.shippingAddress.street }}
            </p>
            <p class="text-gray-700">
              {{ order.shippingAddress.city }}, {{ order.shippingAddress.state }} {{ order.shippingAddress.zipCode }}
            </p>
            <p class="text-gray-700">
              {{ order.shippingAddress.country }}
            </p>
            <p class="text-gray-700">
              Tel: {{ order.shippingAddress.phone }}
            </p>
          </div>
        </p-card>
      </div>

      <!-- Coluna direita: Totais + Ações -->
      <div class="space-y-4">
        <!-- Card: Resumo de Totais -->
        <p-card header="Resumo">
          <div class="space-y-3">
            <!-- Subtotal -->
            <div class="flex justify-between items-center pb-2">
              <span class="text-gray-600">Subtotal:</span>
              <span class="font-medium">{{ formatCurrency(order.subtotal) }}</span>
            </div>

            <!-- Entrega -->
            <div class="flex justify-between items-center pb-2">
              <span class="text-gray-600">Entrega:</span>
              <span class="font-medium">{{ formatCurrency(order.shippingCost) }}</span>
            </div>

            <!-- Total -->
            <div class="flex justify-between items-center pt-2 border-t border-gray-200">
              <span class="text-lg font-semibold">Total:</span>
              <span class="text-lg font-bold text-green-700">
                {{ formatCurrency(order.total) }}
              </span>
            </div>

            <!-- Método de pagamento -->
            <div class="pt-3 border-t border-gray-200">
              <div class="flex items-center gap-2">
                <i [class]="'pi ' + getPaymentMethodIcon(order.paymentMethod) + ' text-gray-600'"></i>
                <span class="text-gray-700 font-medium">
                  {{ formatPaymentMethod(order.paymentMethod) }}
                </span>
              </div>
            </div>

            <!-- Total de itens -->
            <div class="pt-2">
              <div class="flex items-center gap-2 text-sm text-gray-600">
                <i class="pi pi-shopping-cart"></i>
                <span>{{ getTotalItems() }} produto(s)</span>
              </div>
            </div>
          </div>
        </p-card>

        <!-- Card: Ações Admin -->
        <p-card header="Ações Admin">
          <div class="space-y-3">
            <div class="mb-2">
              <label for="status" class="text-sm font-medium text-gray-700 block mb-2">
                Alterar Estado
              </label>
              <p-select
                id="status"
                [options]="changeStatusOptions"
                [(ngModel)]="selectedStatus"
                optionLabel="label"
                optionValue="value"
                placeholder="Selecione estado"
                [showClear]="false"
                [disabled]="updatingStatus"
                styleClass="w-full"
              />
            </div>

            <p-button
              label="Salvar Alterações"
              icon="pi pi-check"
              severity="success"
              (onClick)="changeStatus()"
              [disabled]="updatingStatus || selectedStatus === order.status"
              [loading]="updatingStatus"
              styleClass="w-full"
            />
          </div>
        </p-card>
      </div>
    </div>

    <!-- Card: Produtos -->
    <p-card header="Produtos ({{ order.items.length }} itens)">
      <p-table
        [value]="order.items"
        [tableStyle]="{ 'min-width': '50rem' }"
        styleClass="p-datatable-sm"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="font-semibold" style="width: 5rem">Imagem</th>
            <th class="font-semibold" style="min-width: 15rem">Produto</th>
            <th class="font-semibold" style="min-width: 10rem">Variante</th>
            <th class="font-semibold text-center" style="width: 8rem">Quantidade</th>
            <th class="font-semibold text-right" style="width: 10rem">Preço Un.</th>
            <th class="font-semibold text-right" style="width: 10rem">Subtotal</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-item>
          <tr>
            <!-- Imagem -->
            <td>
              @if (item.productImage) {
                <img
                  [src]="item.productImage"
                  [alt]="item.productName"
                  class="w-16 h-16 object-cover rounded border border-gray-200"
                />
              } @else {
                <div class="w-16 h-16 bg-gray-100 rounded flex items-center justify-center">
                  <i class="pi pi-image text-gray-400 text-2xl"></i>
                </div>
              }
            </td>

            <!-- Nome do produto -->
            <td>
              <span class="font-medium text-gray-900">{{ item.productName }}</span>
              <div class="text-xs text-gray-500 mt-1">SKU: {{ item.variantSKU }}</div>
            </td>

            <!-- Variante (tamanho + cor) -->
            <td>
              <div class="space-y-1">
                <div class="text-sm">
                  <span class="text-gray-600">Tamanho:</span>
                  <span class="font-medium ml-1">{{ item.variantSize }}</span>
                </div>
                <div class="text-sm">
                  <span class="text-gray-600">Cor:</span>
                  <span class="font-medium ml-1">{{ item.variantColor }}</span>
                </div>
              </div>
            </td>

            <!-- Quantidade -->
            <td class="text-center">
              <span class="font-semibold text-lg">{{ item.quantity }}</span>
            </td>

            <!-- Preço unitário -->
            <td class="text-right">
              <span class="font-medium">{{ formatCurrency(item.price) }}</span>
            </td>

            <!-- Subtotal -->
            <td class="text-right">
              <span class="font-semibold text-green-700">
                {{ formatCurrency(item.subtotal) }}
              </span>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>

    <!-- Notas (se existirem) -->
    @if (order.notes) {
      <p-card header="Notas" styleClass="mt-4">
        <p class="text-gray-700 whitespace-pre-wrap">{{ order.notes }}</p>
      </p-card>
    }
  </div>
}

<!-- Modal de detalhe do usuário (readonly) -->
<app-user-detail
  [user]="selectedUser()"
  [visible]="showUserDetail()"
  [readonly]="true"
  (visibleChange)="closeUserDetail()"
/>
