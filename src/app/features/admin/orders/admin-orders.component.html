<!-- Toast para notificaciones -->
<p-toast />

<!-- Contenedor principal -->
<div class="p-4">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestión de Órdenes</h1>
    <p class="text-gray-600">Administra todas las órdenes de la tienda</p>
  </div>

  <!-- Filtros -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Búsqueda por número de orden -->
      <div class="flex flex-col">
        <label for="search" class="text-sm font-medium text-gray-700 mb-2">
          Buscar por número
        </label>
        <p-iconfield>
          <p-inputicon styleClass="pi pi-search" />
          <input
            pInputText
            type="text"
            id="search"
            [(ngModel)]="searchTerm"
            (keyup.enter)="onSearch()"
            placeholder="ej: ORD-2025-00001"
            class="w-full"
          />
        </p-iconfield>
      </div>

      <!-- Filtro por estado de orden -->
      <div class="flex flex-col">
        <label for="status" class="text-sm font-medium text-gray-700 mb-2">
          Estado Orden
        </label>
        <p-select
          id="status"
          [options]="statusOptions"
          [(ngModel)]="selectedStatus"
          (onChange)="onFilterChange()"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos"
          [showClear]="true"
          styleClass="w-full"
        />
      </div>

      <!-- Filtro por estado de pago -->
      <div class="flex flex-col">
        <label for="paymentStatus" class="text-sm font-medium text-gray-700 mb-2">
          Estado Pago
        </label>
        <p-select
          id="paymentStatus"
          [options]="paymentStatusOptions"
          [(ngModel)]="selectedPaymentStatus"
          (onChange)="onFilterChange()"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos"
          [showClear]="true"
          styleClass="w-full"
        />
      </div>

      <!-- Filtro por rango de fechas -->
      <div class="flex flex-col">
        <label for="dateRange" class="text-sm font-medium text-gray-700 mb-2">
          Rango de Fechas
        </label>
        <p-datepicker
          id="dateRange"
          [(ngModel)]="dateRange"
          (onSelect)="onFilterChange()"
          (onClearClick)="onFilterChange()"
          selectionMode="range"
          [readonlyInput]="true"
          [showIcon]="true"
          dateFormat="dd/mm/yy"
          placeholder="Selecciona rango"
          [showClear]="true"
          styleClass="w-full"
        />
      </div>
    </div>

    <!-- Botones de acción -->
    <div class="flex gap-2 mt-4">
      <p-button
        label="Buscar"
        icon="pi pi-search"
        (onClick)="onSearch()"
        [disabled]="loading"
      />
      <p-button
        label="Limpiar Filtros"
        icon="pi pi-filter-slash"
        severity="secondary"
        (onClick)="clearFilters()"
        [disabled]="loading"
      />
    </div>
  </div>

  <!-- Tabla de órdenes -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <p-table
      [value]="orders"
      [lazy]="true"
      (onLazyLoad)="onLazyLoad($event)"
      [paginator]="true"
      [rows]="rowsPerPage"
      [totalRecords]="totalRecords"
      [loading]="loading"
      [first]="first"
      [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} órdenes"
      [tableStyle]="{ 'min-width': '60rem' }"
      styleClass="p-datatable-sm"
    >
      <!-- Columna: Número de Orden -->
      <ng-template pTemplate="header">
        <tr>
          <th class="font-semibold" style="min-width: 10rem">Número</th>
          <th class="font-semibold" style="min-width: 12rem">Cliente</th>
          <th class="font-semibold text-right" style="min-width: 10rem">Total</th>
          <th class="font-semibold text-center" style="min-width: 10rem">Estado Orden</th>
          <th class="font-semibold text-center" style="min-width: 10rem">Estado Pago</th>
          <th class="font-semibold text-center" style="min-width: 10rem">Fecha</th>
          <th class="font-semibold text-center" style="min-width: 12rem">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-order>
        <tr>
          <!-- Número de orden (clickeable) -->
          <td>
            <button
              class="text-blue-600 hover:text-blue-800 font-medium hover:underline"
              (click)="viewOrderDetail(order.id)"
            >
              {{ order.orderNumber }}
            </button>
          </td>

          <!-- Cliente -->
          <td>
            <span class="font-medium">{{ order.customerName }}</span>
          </td>

          <!-- Total -->
          <td class="text-right">
            <span class="font-semibold text-green-700">
              {{ formatCurrency(order.total) }}
            </span>
          </td>

          <!-- Estado orden (badge) -->
          <td class="text-center">
            <p-tag
              [value]="formatOrderStatus(order.status)"
              [severity]="getOrderStatusSeverity(order.status)"
            />
          </td>

          <!-- Estado pago (badge) -->
          <td class="text-center">
            <p-tag
              [value]="formatPaymentStatus(order.paymentStatus)"
              [severity]="getPaymentStatusSeverity(order.paymentStatus)"
            />
          </td>

          <!-- Fecha -->
          <td class="text-center text-sm text-gray-600">
            {{ formatDate(order.createdAt) }}
          </td>

          <!-- Acciones -->
          <td class="text-center">
            <div class="flex items-center justify-center gap-2">
              <!-- Ver detalle -->
              <p-button
                icon="pi pi-eye"
                severity="info"
                [text]="true"
                [rounded]="true"
                pTooltip="Ver Detalle"
                tooltipPosition="top"
                (onClick)="viewOrderDetail(order.id)"
              />

              <!-- Cambiar estado (select) -->
              <p-select
                [options]="changeStatusOptions"
                [(ngModel)]="order.status"
                (onChange)="changeOrderStatus(order, order.status)"
                optionLabel="label"
                optionValue="value"
                placeholder="Cambiar"
                [showClear]="false"
                styleClass="w-auto"
                appendTo="body"
              >
                <ng-template pTemplate="selectedItem">
                  <i class="pi pi-refresh text-gray-600"></i>
                </ng-template>
              </p-select>
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Loading skeleton -->
      <ng-template pTemplate="loadingbody">
        <tr>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
        </tr>
      </ng-template>

      <!-- Empty state -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" style="text-align: center !important; vertical-align: middle; padding: 4rem 0; width: 100%;">
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; width: 100%;">
              <i class="pi pi-inbox" style="font-size: 4rem; color: #9ca3af;"></i>
              <p style="font-size: 1.125rem; font-weight: 500; color: #4b5563; margin: 0;">
                No se encontraron órdenes
              </p>
              <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">
                @if (searchTerm || selectedStatus || selectedPaymentStatus || dateRange) {
                  <span>Intenta cambiar los filtros de búsqueda</span>
                } @else {
                  <span>Aún no hay órdenes registradas en el sistema</span>
                }
              </p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
