<!-- Toast para notificações -->
<p-toast />

<!-- Diálogo de confirmação com template headless -->
<p-confirmDialog key="changeStatus">
  <ng-template #headless let-message let-onAccept="onAccept" let-onReject="onReject">
    <div class="flex flex-col items-center p-8 bg-surface-0 dark:bg-surface-900 rounded">
      <div class="rounded-full bg-primary text-primary-contrast inline-flex justify-center items-center h-24 w-24 -mt-20">
        <i [class]="message.icon || 'pi pi-refresh'" class="!text-5xl"></i>
      </div>
      <span class="font-bold text-2xl block mb-2 mt-6">{{ message.header }}</span>
      <p class="mb-0 text-center text-gray-700">{{ message.message }}</p>

      @if (pendingStatusChange) {
        <div class="status-change-info mt-4">
          <div class="flex items-center justify-center gap-3">
            <span class="text-lg font-semibold text-gray-700">{{ pendingStatusChange.from }}</span>
            <i class="pi pi-arrow-right text-primary text-xl"></i>
            <span class="text-lg font-semibold text-primary">{{ pendingStatusChange.to }}</span>
          </div>
        </div>
      }

      <div class="flex items-center gap-2 mt-6">
        <p-button
          [label]="message.acceptLabel || 'Confirmar'"
          (onClick)="onAccept()"
          styleClass="w-32"
        ></p-button>
        <p-button
          label="Cancelar"
          [outlined]="true"
          (onClick)="onReject()"
          styleClass="w-32"
        ></p-button>
      </div>
    </div>
  </ng-template>
</p-confirmDialog>

<!-- Contêiner principal -->
<div class="p-4">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">Gestão de Pedidos</h1>
    <p class="text-gray-600">Administre todos os pedidos da loja</p>
  </div>

  <!-- Filtros -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
      <!-- Búsqueda por número de pedido -->
      <div class="flex flex-col">
        <label for="search" class="text-sm font-medium text-gray-700 mb-2">
          Buscar por número
        </label>
        <p-iconfield>
          <p-inputicon styleClass="pi pi-search" />
          <input
            pInputText
            type="text"
            id="search"
            [(ngModel)]="searchTerm"
            (keyup.enter)="onSearch()"
            placeholder="ex: PED-2025-00001"
            class="w-full"
          />
        </p-iconfield>
      </div>

      <!-- Filtro por estado de pedido -->
      <div class="flex flex-col">
        <label for="status" class="text-sm font-medium text-gray-700 mb-2">
          Estado Pedido
        </label>
        <p-select
          id="status"
          [options]="statusOptions"
          [(ngModel)]="selectedStatus"
          (onChange)="onFilterChange()"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos"
          [showClear]="true"
          styleClass="w-full"
        />
      </div>

      <!-- Filtro por estado de pagamento -->
      <div class="flex flex-col">
        <label for="paymentStatus" class="text-sm font-medium text-gray-700 mb-2">
          Estado Pagamento
        </label>
        <p-select
          id="paymentStatus"
          [options]="paymentStatusOptions"
          [(ngModel)]="selectedPaymentStatus"
          (onChange)="onFilterChange()"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos"
          [showClear]="true"
          styleClass="w-full"
        />
      </div>

      <!-- Filtro por tipo de pedido (guest/registered) -->
      <div class="flex flex-col">
        <label for="orderType" class="text-sm font-medium text-gray-700 mb-2">
          Tipo de Pedido
        </label>
        <p-select
          id="orderType"
          [options]="orderTypeOptions"
          [(ngModel)]="selectedOrderType"
          (onChange)="onFilterChange()"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos"
          [showClear]="true"
          styleClass="w-full"
        />
      </div>

      <!-- Filtro por intervalo de datas -->
      <div class="flex flex-col">
        <label for="dateRange" class="text-sm font-medium text-gray-700 mb-2">
          Intervalo de Datas
        </label>
        <p-datepicker
          id="dateRange"
          [(ngModel)]="dateRange"
          (onSelect)="onFilterChange()"
          (onClearClick)="onFilterChange()"
          selectionMode="range"
          [readonlyInput]="true"
          [showIcon]="true"
          dateFormat="dd/mm/yy"
          placeholder="Selecione intervalo"
          [showClear]="true"
          styleClass="w-full"
        />
      </div>
    </div>

    <!-- Botões de ação -->
    <div class="flex gap-2 mt-4">
      <p-button
        label="Buscar"
        icon="pi pi-search"
        (onClick)="onSearch()"
        [disabled]="loading"
      />
      <p-button
        label="Limpar Filtros"
        icon="pi pi-filter-slash"
        severity="secondary"
        (onClick)="clearFilters()"
        [disabled]="loading"
      />
    </div>
  </div>

  <!-- Tabela de pedidos -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 -mb-5">
    <p-table
      [value]="orders"
      [lazy]="true"
      (onLazyLoad)="onLazyLoad($event)"
      [paginator]="true"
      [rows]="rowsPerPage"
      [totalRecords]="totalRecords"
      [loading]="loading"
      [first]="first"
      [rowsPerPageOptions]="[10, 25, 50]"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} pedidos"
      [tableStyle]="{ 'min-width': '60rem' }"
      styleClass="p-datatable-sm"
    >
      <!-- Coluna: Número de Pedido -->
      <ng-template pTemplate="header">
        <tr>
          <th class="font-semibold" style="min-width: 10rem">Número</th>
          <th class="font-semibold" style="min-width: 12rem">Cliente</th>
          <th class="font-semibold text-center" style="min-width: 8rem">Tipo</th>
          <th class="font-semibold text-right" style="min-width: 10rem">Total</th>
          <th class="font-semibold text-center" style="min-width: 10rem">Estado Pedido</th>
          <th class="font-semibold text-center" style="min-width: 10rem">Estado Pagamento</th>
          <th class="font-semibold text-center" style="min-width: 10rem">Data</th>
          <th class="font-semibold text-center" style="min-width: 12rem">Ações</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-order>
        <tr>
          <!-- Número de pedido (clickável) -->
          <td>
            <button
              class="text-blue-600 hover:text-blue-800 font-medium hover:underline"
              (click)="viewOrderDetail(order.id)"
            >
              {{ order.orderNumber }}
            </button>
          </td>

          <!-- Cliente -->
          <td>
            <span class="font-medium">{{ order.customerName }}</span>
          </td>

          <!-- Tipo (guest/registered) -->
          <td class="text-center">
            <p-tag
              [value]="formatOrderType(order.isGuest)"
              [severity]="getOrderTypeSeverity(order.isGuest)"
            />
          </td>

          <!-- Total -->
          <td class="text-right">
            <span class="font-semibold text-green-700">
              {{ formatCurrency(order.total) }}
            </span>
          </td>

          <!-- Estado pedido (badge clicável / seletor) -->
          <td class="text-center">
            @if (editingOrderId !== order.id) {
              <!-- Badge editável (se não for estado final) -->
              @if (canEditStatus(order)) {
                <div
                  class="cursor-pointer transition-all hover:scale-105 inline-block"
                  (click)="startEditOrderStatus(order)"
                  title="Clique para alterar estado"
                >
                  <p-tag
                    [value]="formatOrderStatus(order.status) + ' ✎'"
                    [severity]="getOrderStatusSeverity(order.status)"
                  />
                </div>
              } @else {
                <!-- Badge não editável (estados finais) -->
                <p-tag
                  [value]="formatOrderStatus(order.status)"
                  [severity]="getOrderStatusSeverity(order.status)"
                />
              }
            } @else {
              <!-- Seletor ativo -->
              <p-select
                [options]="changeStatusOptions"
                [(ngModel)]="order.status"
                (onChange)="onOrderStatusChange(order)"
                optionLabel="label"
                optionValue="value"
                [showClear]="false"
                styleClass="w-auto"
                appendTo="body"
              />
            }
          </td>

          <!-- Estado pagamento (badge) -->
          <td class="text-center">
            <p-tag
              [value]="formatPaymentStatus(order.paymentStatus)"
              [severity]="getPaymentStatusSeverity(order.paymentStatus)"
            />
          </td>

          <!-- Data -->
          <td class="text-center text-sm text-gray-600">
            {{ formatDate(order.createdAt) }}
          </td>

          <!-- Ações -->
          <td class="text-center">
            <!-- Ver detalhes -->
            <p-button
              icon="pi pi-eye"
              severity="info"
              [text]="true"
              [rounded]="true"
              pTooltip="Ver Detalhes"
              tooltipPosition="top"
              (onClick)="viewOrderDetail(order.id)"
            />
          </td>
        </tr>
      </ng-template>

      <!-- Loading skeleton -->
      <ng-template pTemplate="loadingbody">
        <tr>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
          <td><p-skeleton height="1.5rem" styleClass="mb-2" /></td>
        </tr>
      </ng-template>

      <!-- Empty state -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" style="text-align: center !important; vertical-align: middle; padding: 4rem 0; width: 100%;">
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; width: 100%;">
              <i class="pi pi-inbox" style="font-size: 4rem; color: #9ca3af;"></i>
              <p style="font-size: 1.125rem; font-weight: 500; color: #4b5563; margin: 0;">
                Nenhum pedido encontrado
              </p>
              <p style="font-size: 0.875rem; color: #6b7280; margin: 0;">
                @if (searchTerm || selectedStatus || selectedPaymentStatus || dateRange) {
                  <span>Tente alterar os filtros de busca</span>
                } @else {
                  <span>Ainda não há pedidos registrados no sistema</span>
                }
              </p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
