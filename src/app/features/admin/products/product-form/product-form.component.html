<!-- Toasts para notificações -->
<p-toast></p-toast>

<!-- Container principal -->
<div class="form-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1 class="page-title">
        <i [class]="isEditMode() ? 'pi pi-pencil' : 'pi pi-plus-circle'"></i>
        {{ isEditMode() ? 'Editar Produto' : 'Novo Produto' }}
      </h1>
      <p class="page-subtitle">
        {{ isEditMode() ? 'Modifique os dados do produto' : 'Preencha o formulário para criar um novo produto' }}
      </p>
    </div>
    <div class="header-right">
      <p-button
        label="Voltar"
        icon="pi pi-arrow-left"
        (onClick)="goBack()"
        severity="secondary"
        [outlined]="true"
      ></p-button>
    </div>
  </div>

  <!-- Formulário -->
  <p-card>
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
      <div class="form-grid">
        <!-- Código -->
        <div class="form-field">
          <label for="code" class="form-label required">
            Código
            <app-tooltip-icon text="Identificador único do produto"></app-tooltip-icon>
          </label>
          <input
            pInputText
            id="code"
            formControlName="code"
            placeholder="Ex: CAMISA-001"
            class="w-full"
            [class.ng-invalid]="f['code'].invalid && f['code'].touched"
            [class.ng-dirty]="f['code'].touched"
          />
          @if (f['code'].invalid && f['code'].touched) {
            <small class="error-message">
              {{ getErrorMessage(f['code']) }}
            </small>
          }
        </div>

        <!-- Nome -->
        <div class="form-field">
          <label for="name" class="form-label required">Nome</label>
          <input
            pInputText
            id="name"
            formControlName="name"
            placeholder="Ex: Camisa Oversize Preta"
            class="w-full"
            [class.ng-invalid]="f['name'].invalid && f['name'].touched"
            [class.ng-dirty]="f['name'].touched"
          />
          @if (f['name'].invalid && f['name'].touched) {
            <small class="error-message">
              {{ getErrorMessage(f['name']) }}
            </small>
          }
        </div>

        <!-- Descrição (span 2 colunas) -->
        <div class="form-field form-field-full">
          <label for="description" class="form-label">
            Descrição
            <app-tooltip-icon text="Opcional - Informação adicional do produto"></app-tooltip-icon>
          </label>
          <textarea
            pInputTextarea
            id="description"
            formControlName="description"
            placeholder="Descreva o produto..."
            rows="4"
            class="w-full"
          ></textarea>
        </div>

        <!-- Tags (span 2 colunas) -->
        <div class="form-field form-field-full">
          <label for="tags" class="form-label">
            Tags
            <app-tooltip-icon text="Opcional - Palavras-chave para organizar e pesquisar produtos (Ex: verão, promoção, novo)"></app-tooltip-icon>
          </label>

          <!-- Input para adicionar tags -->
          <div class="tag-input-container">
            <input
              pInputText
              type="text"
              [(ngModel)]="tagInput"
              [ngModelOptions]="{standalone: true}"
              (keydown.enter)="addTag($event)"
              placeholder="Digite e pressione Enter para adicionar"
              class="w-full"
            />
          </div>

          <!-- Lista de tags adicionadas -->
          @if (productForm.get('tags')?.value?.length > 0) {
            <div class="tags-display">
              @for (tag of productForm.get('tags')?.value; track tag; let i = $index) {
                <div class="tag-chip">
                  <span>{{ tag }}</span>
                  <button
                    type="button"
                    class="tag-remove"
                    (click)="removeTag(i)"
                    [attr.aria-label]="'Remover tag ' + tag"
                  >
                    <i class="pi pi-times"></i>
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <!-- Preço Base -->
        <div class="form-field">
          <label for="basePrice" class="form-label required">
            Preço Base
            <app-tooltip-icon text="Preço base do produto (sem variantes)"></app-tooltip-icon>
          </label>
          <p-inputNumber
            inputId="basePrice"
            formControlName="basePrice"
            mode="currency"
            currency="BRL"
            locale="pt-BR"
            [min]="0"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            placeholder="0.00"
            styleClass="w-full"
          ></p-inputNumber>
          @if (f['basePrice'].invalid && f['basePrice'].touched) {
            <small class="error-message">
              {{ getErrorMessage(f['basePrice']) }}
            </small>
          }
        </div>

        <!-- Categoria -->
        <div class="form-field">
          <label for="category" class="form-label required">Categoria</label>
          <p-select
            inputId="category"
            formControlName="category"
            [options]="categoryOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecione uma categoria"
            styleClass="w-full"
            [showClear]="false"
          ></p-select>
          @if (f['category'].invalid && f['category'].touched) {
            <small class="error-message">
              {{ getErrorMessage(f['category']) }}
            </small>
          }
        </div>

        <!-- Estilo -->
        <div class="form-field">
          <label for="style" class="form-label required">
            Estilo
            <app-tooltip-icon text="Selecione primeiro uma categoria para ver os estilos disponíveis"></app-tooltip-icon>
          </label>
          <p-select
            inputId="style"
            formControlName="style"
            [options]="availableStyleOptions"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecione um estilo"
            [disabled]="!f['category'].value || availableStyleOptions.length === 0"
            styleClass="w-full"
            [showClear]="false"
          ></p-select>
          @if (f['style'].invalid && f['style'].touched) {
            <small class="error-message">
              {{ getErrorMessage(f['style']) }}
            </small>
          }
          @if (!f['category'].value) {
            <small class="field-hint">Selecione primeiro uma categoria</small>
          } @else if (availableStyleOptions.length === 0) {
            <small class="field-hint">Não há estilos disponíveis para esta categoria</small>
          }
        </div>

        <!-- Status (apenas em modo edição) -->
        @if (isEditMode()) {
          <div class="form-field">
            <label for="status" class="form-label">
              Status
              <app-tooltip-icon text="Status do produto no sistema"></app-tooltip-icon>
            </label>
            <p-select
              inputId="status"
              formControlName="status"
              [options]="statusOptions"
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
              [showClear]="false"
            ></p-select>
          </div>

          <!-- Destaque (apenas em modo edição) -->
          <div class="form-field">
            <label for="destacado" class="form-label">
              Produto em Destaque
              <app-tooltip-icon text="Os produtos em destaque aparecem na home (máximo 12)"></app-tooltip-icon>
            </label>
            <div class="flex items-center gap-3">
              <p-toggleSwitch
                inputId="destacado"
                formControlName="destacado"
              />
              <span class="text-sm text-gray-600">
                {{ f['destacado'].value ? 'Sim, mostrar na home' : 'Não mostrar na home' }}
              </span>
            </div>
          </div>
        }
      </div>

      <!-- Gestão de Variantes (apenas modo CRIAR) -->
      @if (!isEditMode()) {
        <p-fieldset legend="Variantes" [toggleable]="true" [collapsed]="false" styleClass="mb-4">
          <p class="mb-4 text-gray-600">
            Adicione as variantes do produto (combinações de tamanho e cor).
            <strong>Você deve adicionar pelo menos uma variante.</strong>
          </p>

          <!-- Formulário inline para adicionar variante -->
          <div class="variant-form-grid">
            <!-- Tamanho -->
            <div class="form-field">
              <label for="variantSize" class="form-label required">Tamanho</label>
              <p-select
                inputId="variantSize"
                [(ngModel)]="variantSize"
                [ngModelOptions]="{standalone: true}"
                [options]="sizeOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Selecione tamanho"
                styleClass="w-full"
                [showClear]="true"
              ></p-select>
            </div>

            <!-- Cor -->
            <div class="form-field">
              <label for="variantColor" class="form-label required">Cor</label>
              <p-select
                inputId="variantColor"
                [(ngModel)]="variantColor"
                [ngModelOptions]="{standalone: true}"
                [options]="colorOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Selecione cor"
                styleClass="w-full"
                [showClear]="true"
              ></p-select>
            </div>

            <!-- Estoque -->
            <div class="form-field">
              <label for="variantStock" class="form-label required">Estoque</label>
              <p-inputNumber
                inputId="variantStock"
                [(ngModel)]="variantStock"
                [ngModelOptions]="{standalone: true}"
                [min]="0"
                [showButtons]="true"
                placeholder="0"
                styleClass="w-full"
              ></p-inputNumber>
            </div>
          </div>

          <!-- Botão Adicionar Variante -->
          <div class="mt-3">
            <p-button
              type="button"
              label="Adicionar Variante"
              icon="pi pi-plus"
              (onClick)="addVariant()"
              severity="secondary"
              [outlined]="true"
            ></p-button>
          </div>

          <!-- Lista de variantes adicionadas -->
          @if (variants.length > 0) {
            <div class="mt-4">
              <h4 class="font-semibold mb-3">Variantes adicionadas ({{ variants.length }})</h4>

              <!-- Tabela simples de variantes -->
              <div class="variants-table">
                <!-- Header -->
                <div class="variants-table-header">
                  <div class="variant-col-size">Tamanho</div>
                  <div class="variant-col-color">Cor</div>
                  <div class="variant-col-stock">Estoque</div>
                  <div class="variant-col-actions">Ação</div>
                </div>

                <!-- Linhas -->
                @for (variant of variants; track $index) {
                  <div class="variants-table-row">
                    <div class="variant-col-size">
                      <p-tag
                        [value]="formatSize(variant.size)"
                        [severity]="getSizeSeverity(variant.size)"
                      ></p-tag>
                    </div>
                    <div class="variant-col-color">
                      <p-tag
                        [value]="formatColor(variant.color)"
                        [style.backgroundColor]="getColorHex(variant.color)"
                        [style.color]="getTextColor(variant.color)"
                      ></p-tag>
                    </div>
                    <div class="variant-col-stock">
                      <strong>{{ variant.stock }}</strong>
                    </div>
                    <div class="variant-col-actions">
                      <button
                        type="button"
                        class="variant-remove-btn"
                        (click)="removeVariant($index)"
                        [attr.aria-label]="'Remover variante'"
                      >
                        <i class="pi pi-trash"></i>
                      </button>
                    </div>
                  </div>
                }
              </div>
            </div>
          } @else {
            <div class="empty-state mt-4">
              <i class="pi pi-inbox text-gray-400 text-4xl"></i>
              <p class="text-gray-600 mt-2">Nenhuma variante adicionada</p>
              <small class="text-gray-500">Adicione pelo menos uma variante antes de criar o produto</small>
            </div>
          }
        </p-fieldset>
      }

      <!-- Gestão de Variantes (apenas modo EDIÇÃO) -->
      @if (isEditMode() && currentProduct) {
        <p-fieldset legend="Variantes" [toggleable]="true" [collapsed]="false" styleClass="mb-4">
          <!-- Diálogo de Confirmação -->
          <p-confirmdialog />

          <!-- Botão Adicionar Variante -->
          <div class="mb-4">
            <p-button
              type="button"
              [label]="showAddVariantForm ? 'Cancelar' : 'Adicionar Nova Variante'"
              [icon]="showAddVariantForm ? 'pi pi-times' : 'pi pi-plus'"
              (onClick)="toggleAddVariantForm()"
              [severity]="showAddVariantForm ? 'secondary' : 'success'"
              [outlined]="true"
            ></p-button>
          </div>

          <!-- Formulário inline para adicionar variante (retrátil) -->
          @if (showAddVariantForm) {
            <div class="variant-form-grid mb-4">
              <!-- Tamanho -->
              <div class="form-field">
                <label for="variantSizeEdit" class="form-label required">Tamanho</label>
                <p-select
                  inputId="variantSizeEdit"
                  [(ngModel)]="variantSize"
                  [ngModelOptions]="{standalone: true}"
                  [options]="sizeOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Selecione tamanho"
                  styleClass="w-full"
                  [showClear]="true"
                ></p-select>
              </div>

              <!-- Cor -->
              <div class="form-field">
                <label for="variantColorEdit" class="form-label required">Cor</label>
                <p-select
                  inputId="variantColorEdit"
                  [(ngModel)]="variantColor"
                  [ngModelOptions]="{standalone: true}"
                  [options]="colorOptions"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Selecione cor"
                  styleClass="w-full"
                  [showClear]="true"
                ></p-select>
              </div>

              <!-- Estoque -->
              <div class="form-field">
                <label for="variantStockEdit" class="form-label required">Estoque</label>
                <p-inputNumber
                  inputId="variantStockEdit"
                  [(ngModel)]="variantStock"
                  [ngModelOptions]="{standalone: true}"
                  [min]="0"
                  [showButtons]="true"
                  placeholder="0"
                  styleClass="w-full"
                ></p-inputNumber>
              </div>

              <!-- Botões do formulário inline -->
              <div class="form-field" style="grid-column: span 4;">
                <div class="flex gap-2">
                  <p-button
                    type="button"
                    label="Adicionar"
                    icon="pi pi-check"
                    (onClick)="addVariantToProduct()"
                    severity="success"
                  ></p-button>
                  <p-button
                    type="button"
                    label="Cancelar"
                    icon="pi pi-times"
                    (onClick)="toggleAddVariantForm()"
                    severity="secondary"
                    [outlined]="true"
                  ></p-button>
                </div>
              </div>
            </div>
          }

          <!-- Tabela de variantes -->
          <p-table
            [value]="currentProduct.variants"
            styleClass="p-datatable-sm"
            [tableStyle]="{ 'min-width': '46rem' }"
          >
            <ng-template pTemplate="header">
              <tr>
                <th style="min-width: 7rem">Tamanho</th>
                <th style="min-width: 9rem">Cor</th>
                <th style="min-width: 10rem">SKU</th>
                <th style="min-width: 6rem">Estoque</th>
                <th style="min-width: 6rem; text-align: center">Ações</th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-variant>
              <tr>
                <!-- Tamanho (badge) -->
                <td>
                  <p-tag
                    [value]="formatSize(variant.size)"
                    [severity]="getSizeSeverity(variant.size)"
                  ></p-tag>
                </td>

                <!-- Cor (chip com cor) -->
                <td>
                  <p-tag
                    [value]="formatColor(variant.color)"
                    [style.backgroundColor]="getColorHex(variant.color)"
                    [style.color]="getTextColor(variant.color)"
                  ></p-tag>
                </td>

                <!-- SKU (somente leitura) -->
                <td>
                  <span class="text-xs font-mono text-gray-600">{{ variant.sku }}</span>
                </td>

                <!-- Estoque (editável) -->
                <td>
                  @if (editingVariantSku === variant.sku) {
                    <p-inputNumber
                      [(ngModel)]="variant.stock"
                      [ngModelOptions]="{standalone: true}"
                      [min]="0"
                      [showButtons]="true"
                      placeholder="0"
                      (onBlur)="saveVariantChanges(variant)"
                      (keydown.enter)="saveVariantChanges(variant)"
                      (keydown.escape)="cancelEditVariant()"
                      styleClass="w-full"
                    ></p-inputNumber>
                  } @else {
                    <span
                      class="cursor-pointer hover:underline"
                      (click)="startEditVariant(variant)"
                      title="Clique para editar"
                    >
                      {{ variant.stock }}
                    </span>
                  }
                </td>

                <!-- Ações -->
                <td style="text-align: center">
                  <p-button
                    icon="pi pi-trash"
                    severity="danger"
                    [text]="true"
                    [rounded]="true"
                    pTooltip="Remover Variante"
                    tooltipPosition="top"
                    (onClick)="deleteVariantFromProduct(variant)"
                  ></p-button>
                </td>
              </tr>
            </ng-template>

            <!-- Empty state -->
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="5" style="text-align: center; padding: 2rem">
                  <div class="empty-state">
                    <i class="pi pi-inbox text-gray-400 text-4xl"></i>
                    <p class="text-gray-600 mt-2">Nenhuma variante</p>
                    <small class="text-gray-500">Adicione pelo menos uma variante para este produto</small>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-fieldset>
      }

      <!-- Gestão de Imagens -->
      @if (isEditMode() && productId) {
        <app-image-upload
          [productId]="productId"
          [currentImages]="productImages()"
          [featuredImageIndex]="productFeaturedIndex()"
          (imagesChanged)="onImagesChanged($event)"
          (featuredImageChanged)="onFeaturedImageChanged($event)"
          class="mb-6"
        />
      } @else {
        <!-- Mensagem em modo criar -->
        <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
          <p class="text-gray-600 text-center">
            <i class="pi pi-info-circle mr-2"></i>
            Salve o produto primeiro para poder adicionar imagens
          </p>
        </div>
      }

      <!-- Botões -->
      <div class="form-actions">
        <p-button
          type="button"
          label="Cancelar"
          icon="pi pi-times"
          (onClick)="goBack()"
          severity="secondary"
          [outlined]="true"
        ></p-button>

        @if (!isEditMode()) {
          <p-button
            type="button"
            label="Limpar"
            icon="pi pi-refresh"
            (onClick)="resetForm()"
            severity="secondary"
          ></p-button>
        }

        <p-button
          type="submit"
          [label]="isEditMode() ? 'Atualizar Produto' : 'Criar Produto'"
          [icon]="isEditMode() ? 'pi pi-check' : 'pi pi-plus'"
          severity="success"
          [loading]="isLoading()"
        ></p-button>
      </div>
    </form>
  </p-card>
</div>
